// Generated by CoffeeScript 1.11.1
(function() {
  var _handle_state, processOrgChange, queryParams, setOrgFromQuery, updateLinks;

  _handle_state = true;

  $(window).on("popstate", function(event) {
    if (_handle_state) {
      setOrgFromQuery();
      return location.reload();
    }
  });

  queryParams = function(url_str) {
    var i, len, p, params, pushParam, q, q_parts, queryStart;
    queryStart = url_str.indexOf('?') + 1;
    if (queryStart > 0) {
      q = url_str.substr(queryStart);
    } else {
      q = '';
    }
    q_parts = q.replace(/\+/g, '%20').split('&');
    params = {};
    pushParam = function(p) {
      var name, name_value, value;
      name_value = p.split("=");
      name = decodeURIComponent(name_value[0]);
      value = name_value.length > 1 ? decodeURIComponent(name_value[1]) : null;
      if (!(name in params)) {
        params[name] = [];
      }
      return params[name].push(value);
    };
    for (i = 0, len = q_parts.length; i < len; i++) {
      p = q_parts[i];
      pushParam(p);
    }
    return params;
  };

  setOrgFromQuery = function() {
    var orgVal, params;
    params = queryParams(window.location.href);
    if ('select_org' in params) {
      orgVal = params['select_org'][0];
    } else {
      orgVal = "0";
    }
    $("#select_org").val(orgVal);
    return updateLinks();
  };

  processOrgChange = function() {
    var newLocation, newOrg, ser_inputs;
    newOrg = $('#select_org').val();
    updateLinks();
    ser_inputs = $("#wrap select, #wrap input").serialize();
    newLocation = window.location.pathname + "?" + ser_inputs;
    return window.history.pushState({}, '', newLocation);
  };

  updateLinks = function() {
    var base_link, elem, i, len, link_elems, orgVal, results;
    link_elems = (function() {
      var i, len, ref, results;
      ref = $('#nav_links a');
      results = [];
      for (i = 0, len = ref.length; i < len; i++) {
        elem = ref[i];
        if (elem.getAttribute('href') != null) {
          results.push(elem);
        }
      }
      return results;
    })();
    orgVal = $('#select_org').val();
    results = [];
    for (i = 0, len = link_elems.length; i < len; i++) {
      elem = link_elems[i];
      base_link = elem.getAttribute('href').split('/')[1];
      results.push(elem.setAttribute("href", "/" + base_link + "/?select_org=" + orgVal));
    }
    return results;
  };

  $(function() {
    if ((window.location.pathname.indexOf("/reports/")) >= 0) {
      _handle_state = false;
    }
    if (_handle_state) {
      setOrgFromQuery();
    }
    if (_handle_state) {
      return $("#select_org").change(processOrgChange);
    } else {
      return $("#select_org").change(updateLinks);
    }
  });

}).call(this);
